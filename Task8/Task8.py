import numpy as np
import matplotlib.pyplot as plt
from sklearn.linear_model import LinearRegression


threshold = 1e-9  # tolerance for line fit deviation


# Linear regression over a set of points
def linear_regression(points):
    if len(points) < 2:
        return None, None
    X = points[:, 0].reshape(-1, 1)
    y = points[:, 1]
    model = LinearRegression().fit(X, y)
    m = model.coef_[0]
    b = model.intercept_
    return m, b


# Find the point with maximum perpendicular distance to the line y = mx + b
def find_furthest_point(points, m, b):
    if len(points) < 2:
        return None, None
    distances = np.abs(points[:, 1] - (m * points[:, 0] + b))
    index = np.argmax(distances)
    distance = distances[index]
    return index, distance



# Recursive split-and-merge line segmentation
def compute_line_map(points, threshold):
    segments = []

    # Step 1: Fit a line to all points
    m, b = linear_regression(points)

    # Step 2: Find the point with the maximum distance to the line
    index, distance = find_furthest_point(points, m, b)

    if distance is not None and distance > threshold:
        # Step 3: Use a new line from the first to the last point to decide where to split
        first_last_line = linear_regression(np.array([points[0], points[-1]]))
        split_index, _ = find_furthest_point(points, *first_last_line)

        # Split at the furthest point from the first-to-last line
        left = points[:split_index + 1]
        right = points[split_index:]
        print("left and right: ", left, right)

        if len(left) < 2 or len(right) < 2:
            # Stop if splitting fails
            segments.append((points, m, b))
        else:
            # Recurse on both subsets
            segments += compute_line_map(left, threshold)
            segments += compute_line_map(right, threshold)
    else:
        # Accept this segment
        segments.append((points, m, b))

    return segments


# Example point cloud
points = np.array([[0.99999857, 0.0],
 [1.000114301128284, 0.009818914651541905],
 [1.0005131043938453, 0.019647553847505505],
 [2.0025436370318057, 0.058996838387135],
 [2.0049609551263967, 0.07877513047311566],
 [2.0085001559012, 0.09867128542090983],
 [2.013426765995247, 0.11873798976709406],
 [2.0200629589962005, 0.13904240899008258],
 [2.0287998481874783, 0.15967001085788132],
 [2.04011521127814, 0.18072962262614728],
 [2.05415960010241, 0.20231706173367764],
 [2.072412721688248, 0.22467861236530115],
 [2.0954114856283392, 0.24800829278096262],
 [2.1242504563441367, 0.2725938173991064],
 [2.1602940423691206, 0.29880487249287846],
 [2.203985171029039, 0.326930316864466],
 [4.519421344452415, 0.7158060202318591],
 [4.658330322376438, 0.7847618546592516],
 [4.8268708658819675, 0.861969769458805],
 [5.042463094921434, 0.9516439686490474],
 [5.312995955672269, 1.0568206034213194],
 [6.837695044740748, 1.4300258490391276],
 [6.428314083764195, 1.4104163272622323],
 [6.627058508714011, 1.5223646184939479],
 [3.4848390242343057, 0.8366358285321345],
 [3.3399996796150395, 0.8366263667867054],
 [3.218754568942458, 0.8399226741259033],
 [3.1213950072260057, 0.8473330457152333],
 [3.046206819201637, 0.859119175695785],
 [2.987125576383709, 0.8742041080178556],
 [2.9434068455425857, 0.8928727051024924],
 [2.9126931719421227, 0.9148767122092972],
 [2.893017580544756, 0.9399983934670598],
 [2.8820353042443627, 0.9678125765401854],
 [2.878493908351942, 0.9981746831397412],
 [2.88061734720891, 1.030701367749215],
 [2.8878002168127366, 1.0653657459842],
 [2.8987774986095363, 1.1018660059095393],
 [2.912668972377542, 1.1399966610500023],
 [2.928732675057241, 1.1795701907738034],
 [2.945629873477207, 1.220119843325603],
 [6.864901692117862, 2.9228196874227916],
 [6.909446412462581, 3.022253857053317],
 [4.752781300376605, 2.1347384067811372],
 [4.4608791864280954, 2.05649347284075],
 [4.217387215538135, 1.9946755992439116],
 [4.067055689797113, 1.9726635958302512],
 [4.091055904330768, 2.0341562666581074],
 [4.1140364050762335, 2.0962062485329116],
 [4.093259019242134, 2.136494039325624],
 [4.000376952082473, 2.1382460288889678],
 [4.000390479864088, 2.189015602810718],
 [4.0006705119142145, 2.2404831386107205],
 [4.001236135017332, 2.292688935167012],
 [4.002106276846344, 2.3456750777773685],
 [4.003302473312569, 2.3994871610553496],
 [4.001625996341551, 2.452199564399343],
 [4.003420680390099, 2.5076912522726706],
 [4.002166014250941, 2.561953123915195],
 [4.001092685309812, 2.6169951721247613],
 [4.003860101433056, 2.6752937889949653],
 [4.003297594865595, 2.732144453803157],
 [4.002958264427412, 2.789906525587473],
 [4.002853917317571, 2.848625048169544],
 [4.002999907827353, 2.9083496726381113],
 [4.003407459932951, 2.9691293296088146],
 [4.00409249740404, 3.031018709354609],
 [4.005068494847382, 3.0940732149994323],
 [4.001726919618118, 3.154707131994932],
 [4.003189707654745, 3.220085357194507],
 [4.004982850984543, 3.2868044834355157],
 [4.002098818620821, 3.3507270540024714],
 [4.004449135636918, 3.420122662668365],
 [4.001873185056359, 3.4864466603731183],
 [4.004825196715935, 3.5587762767705944],
 [4.0025883411224745, 3.6277346117253995],
 [4.006187946811059, 3.703282045827857],
 [4.004321538309513, 3.775131460828487],
 [4.002581693543004, 3.8484080568366155],
 [4.007151028730801, 3.9292332548974795],
 [4.005823979296167, 4.005823979296167],
 [4.936309396223571, 5.034197766334163],
 [4.841652912050714, 5.035617592016206],
 [4.748486953678355, 5.0367699192184086],
 [4.6498717897558555, 5.030202962618901],
 [4.559827347873451, 5.030994197078054],
 [4.471172833659955, 5.031579461736265],
 [4.383876740063403, 5.03197681813222],
 [4.297908201966813, 5.032203953464366],
 [4.2132349315850455, 5.032275762995064],
 [4.129828593464222, 5.032210701210188],
 [4.04765852001406, 5.032023418639632],
 [4.010369880308989, 5.087129941443944],
 [4.01132210151106, 5.192385136060811],
 [4.003601428893375, 5.28891174262711],
 [4.004696693874148, 5.3997084125456],
 [4.0059639825672635, 5.513736399664281],
 [4.007402164925554, 5.631153690952324],
 [4.00900894566963, 5.752126583471271],
 [4.010784148316399, 5.8768351402977865],
 [4.012724900013944, 6.005467209352165],
 [1.9872816770117774, 3.038331238145278],
 [1.9446019505856638, 3.0377682422177092],
 [1.9024714132684346, 3.037213370197485],
 [1.8608746672467602, 3.0366714652818505],
 [1.8197961141428958, 3.0361463911599613],
 [1.7792205969001298, 3.0356420572517746],
 [1.740812205151007, 3.038092343313035],
 [1.7011210731526385, 3.0375702442365435],
 [1.6618909371002277, 3.037078710088584],
 [1.623107446059412, 3.036620449772705],
 [1.5847562995442952, 3.036197572757101],
 [1.5468237189785912, 3.0358124810319294],
 [1.5105541715718283, 3.0379974556099674],
 [1.4733534693527859, 3.0376241662692487],
 [1.4365327811823123, 3.0372933766052914],
 [1.4000789636545046, 3.0370060449036202],
 [1.3639785081704117, 3.036761566267424],
 [1.3282190897535633, 3.0365611423554797],
 [1.292788095892688, 3.036404614774231],
 [1.2585344481699623, 3.0383709334856612],
 [1.2236738241784433, 3.0382367581980496],
 [1.189107238556218, 3.038145528761617],
 [1.1548232125976088, 3.0380967609456793],
 [1.1208100989106209, 3.038088711637625],
 [1.087056740381475, 3.0381200624400106],
 [1.0535523087141203, 3.0381895613947965],
 [1.0202860374135134, 3.038295276927758],
 [0.9872472464154866, 3.0384345974145432],
 [0.9544260260362923, 3.03860633029622],
 [0.9213671070787259, 3.037340300286127],
 [0.8889833589597526, 3.0376257720284436],
 [0.8567861450291948, 3.037934516444318],
 [0.8247662057980014, 3.038263561093089],
 [0.7929146507885828, 3.038610259763739],
 [0.7609271309367613, 3.0377913898416704],
 [0.7294111747116325, 3.0382161983277434],
 [0.6980365883968912, 3.0386474149048994],
 [0.6665727666875324, 3.038066860916629],
 [0.6354781773043031, 3.0385506576081633],
 [0.604320287415199, 3.0381232468152723],
 [0.5734704323199484, 3.0386400652620527],
 [0.5425789041226071, 3.038341247623932],
 [0.5119410854447806, 3.0388718149829255],
 [0.48127915737461513, 3.0386770088555037],
 [0.45072649535541087, 3.038551216298002],
 [0.42035646751476974, 3.0390855572983635],
 [0.38998199388248483, 3.039025009352908],
 [0.3596908586279319, 3.039012720071198],
 [0.3294746065873328, 3.039040338448656],
 [0.2993252234223996, 3.0390999947167154],
 [0.2692350965984607, 3.0391842134073705],
 [0.2391969584163111, 3.039285525907914],
 [0.20920383856341937, 3.0393958809497277],
 [0.17923545848104933, 3.039275553081538],
 [0.1493172116795347, 3.0394216681961206],
 [0.11942438251975049, 3.0395535063429078],
 [0.08954812548088024, 3.039553199667158],
 [0.05969144737884132, 3.0396697617575925],
 [0.029843299921794398, 3.0397159058674443],
 [1.861334791719426e-16, 3.0397904],
 [-0.02984493156026786, 3.039882097858093],
 [-0.05969753186013517, 3.039979602021418],
 [-0.08956342675169952, 3.040072574321056],
 [-0.11944785988957406, 3.04015104530658],
 [-0.14935564148206756, 3.0402039247974204],
 [-0.17929119147086622, 3.0402206111347],
 [-0.2092759402352476, 3.0404434024764373],
 [-0.239283765559824, 3.040388515245956],
 [-0.2693586006202406, 3.0405783536143094],
 [-0.2994539101259386, 3.040406572744364],
 [-0.329634523427749, 3.0405153951574477],
 [-0.359876426671038, 3.0405805765510387],
 [-0.3902372177504498, 3.0410139004553116],
 [-0.42061827069725594, 3.0409783371940833],
 [-0.451069052321074, 3.0408605477781663],
 [-0.48167036868478735, 3.041147019857664],
 [-0.5123624241687714, 3.0413728730329646],
 [-0.5431472886548911, 3.04152409560388],
 [-0.5740263624941353, 3.0415857649975027],
 [-0.6050008404945197, 3.041544618187431],
 [-0.6360713643200737, 3.0413869922947474],
 [-0.6673744543673185, 3.0417207467254737],
 [-0.6987944942165015, 3.0419466811579627],
 [-0.7303312062351246, 3.042048405421023],
 [-0.7619842648054661, 3.042011704814944],
 [-0.7937525693360657, 3.041821334111646],
 [-0.8258243637166183, 3.0421615901629226],
 [-0.8580301837549711, 3.0423455450385086],
 [-0.8903681623919895, 3.0423575980548376],
 [-0.9228360056025692, 3.0421826097729987],
 [-0.9556638234294527, 3.0425471061047995],
 [-0.9886373593646819, 3.0427129251530975],
 [-2.3662761241528925, 7.046500009101697],
 [-2.4439038551951486, 7.0476265112728935],
 [-2.5218904014133336, 7.048211504691123],
 [-2.6002246391425046, 7.048217295310813],
 [-2.678893899143096, 7.0476058925044125],
 [-2.7585975403340104, 7.0481622776046455],
 [-1.985777712847469, 4.9304501915241],
 [-1.9849279902445294, 4.792040074382314],
 [-1.9853275291931143, 4.662989774296848],
 [-1.9868421025809802, 4.542298459068715],
 [-1.986828605439261, 4.423474938657056],
 [-1.985568996560115, 4.307032104379466],
 [-1.987834589482498, 4.202923115651372],
 [-1.9867059359673964, 4.096006890333061],
 [-2.01198010407068, 4.046455633262243],
 [-2.06160808653826, 4.046133688874362],
 [-2.1119458031366287, 4.046227626999726],
 [-2.1630048697195643, 4.046697485304956],
 [-2.214792607735898, 4.047497537926943],
 [-2.2667549834886604, 4.0475822664753],
 [-2.3194380092465092, 4.0479190321794585],
 [-2.3721380496242563, 4.047256445655228],
 [-2.42587142799009, 4.047321963306394],
 [-2.4807420412442243, 4.048203085335706],
 [-2.5360907175525007, 4.0487591990415694],
 [-2.5918580484104226, 4.048882119770716],
 [-2.647973797230396, 4.0484555355096745],
 [-2.7053131376238073, 4.048787231582444],
 [-2.763988784261944, 4.049957767375258],
 [-2.82190909746984, 4.048875558940526],
 [-2.8822845002988386, 4.050151777700106],
 [-2.9429398355005936, 4.0506091826174275],
 [-3.003742258986556, 4.050077592587374],
 [-3.0659929655229923, 4.050294837328207],
 [-3.1298152556694965, 4.051334148916351],
 [-3.1936818820267585, 4.05116615434325],
 [-3.2591714741297535, 4.0517813205068025],
 [-3.3245303929401735, 4.050952004721983],
 [-3.3915411171853624, 4.05084701906056],
 [-3.4603347972560434, 4.0515314959713615],
 [-3.531055510130339, 4.0530768824163905],
 [-3.601430317117654, 4.052825397413759],
 [-3.6737415039804775, 4.053349124437842],
 [-3.748139167614836, 4.054714107769845],
 [-3.8218720891012947, 4.053899812986565],
 [-0.9962857067085309, 1.0361985715433761],
 [-0.9962512088040852, 1.016007143698512],
 [-0.996018308321378, 0.9960183083213782],
 [-0.9964372173907433, 0.9770618134723271],
 [-0.9966725829582422, 0.9582822018279561],
 [-0.9967315449163863, 0.9396829343536064],
 [-0.9966211145933447, 0.9212670821158919],
 [-0.9963486796122092, 0.9030378051224915],
 [-0.9967575781224935, 0.8857408372336635],
 [-0.9970147045193117, 0.868602883243361],
 [-0.9971262738578522, 0.851626291470147],
 [-0.9970987147638771, 0.834813379301257],
 [-0.99693851782526, 0.8181662973393512],
 [-0.9966523100632115, 0.8016870905997575],
 [-0.9970646050316854, 0.786022355781672],
 [-0.997355842092039, 0.7704966845911019],
 [-0.996721459825808, 0.7544984024984215],
 [-0.996791309548402, 0.7392708192457901],
 [-0.9967571544827998, 0.7241864628253636],
 [-0.9974187586783239, 0.7098115789819446],
 [-0.9971873714266403, 0.6950008895919758],
 [-0.997651331878971, 0.6808705794738639],
 [-0.9972437831084041, 0.6663369926708621],
 [-0.9975298663841083, 0.652454479238171],
 [-0.9977309614875313, 0.6386891359598708],
 [-0.9978520770374438, 0.6250417141785573],
 [-0.9978975627697676, 0.611512412948231],
 [-0.9978718583138844, 0.5981013746436592],
 [-0.9977802699774219, 0.5848091356105365],
 [-0.9976269107141539, 0.5716353902740311],
 [-0.997416757130254, 0.5585802229558953],
 [-0.9978608055922747, 0.5460299147969607],
 [-0.9975411421044242, 0.5331968490238862],
 [-0.9978658537119385, 0.52084034713661],
 [-0.9981322385915353, 0.5085737775232326],
 [-0.9976748069880805, 0.4960642211154785],
 [-0.9978445103937843, 0.4839893254697661],
 [-0.997966754451546, 0.4720031223661633],
 [-0.9980448073178952, 0.46010495825494563],
 [-0.9980822851484165, 0.4482942623649392],
 [-0.9980825170895996, 0.4365702484486652],
 [-0.9980490895056374, 0.42493216343809326],
 [-0.997985018469456, 0.41337892969521256],
 [-0.9984735019515162, 0.40214308025109147],
 [-0.9983458469195918, 0.39074503242723757],
 [-0.9981973928137059, 0.37942883676188865],
 [-0.9985736117598559, 0.3683932547061174],
 [-0.9983793369793221, 0.35722583881340253],
 [-0.9986902249089769, 0.3463155839624562],
 [-0.9984616682640827, 0.335292131333774],
 [-0.9987170017075558, 0.3245028248174581],
 [-0.9984647097823167, 0.31361769229320235],
 [-0.9986742262660948, 0.3029445145419486],
 [-0.9988576375959555, 0.29232297999621415],
 [-0.998581763718124, 0.28162918430311956],
 [-0.9987326432881246, 0.27111569363488697],
 [-0.9988633801533306, 0.2606498828584104],
 [-0.9989760157586159, 0.25023046549139755],
 [-0.9990721707817171, 0.23985600699275253],
 [-0.9987920421470263, 0.22944201627291944],
 [-0.9988755631040992, 0.21916016933017002],
 [-0.9989477386459098, 0.20891851402492548],
 [-0.9990104286407393, 0.19871552939789627],
 [-0.9990651613407816, 0.18854958721163534],
 [-0.999113129616568, 0.17841896705506738],
 [-0.9991556806798014, 0.1683219546061736],
 [-0.9991944159189008, 0.15825684834071715],
 [-0.999230302176761, 0.1482218136516312],
 [-0.999264558113991, 0.13821503601725235],
 [-0.9995038729872511, 0.1282610416436916],
 [-0.9995216144019108, 0.11830117897399807],
 [-0.9995408572449576, 0.10836425122177137],
 [-0.9995621462109372, 0.09844827852301444],
 [-0.9995862763571979, 0.08855129823532444],
 [-0.9996142941960761, 0.0786713511195176],
 [-0.9996467002561459, 0.0688064125544233],
 [-0.9997752872669982, 0.05895983396755074],
 [-0.9998008437113886, 0.049117065848395945],
 [-0.9998322708099016, 0.03928351690984226],
 [-0.9998696768766516, 0.029457110768543765],
 [-0.999913519991728, 0.019635779522137096],
 [-0.9999638083810354, 0.00981743714498184],
 [-0.99999857, 1.2246450479024304e-16],
 [-1.000114301128284, -0.009818914651541838],
 [-1.0005131043938453, -0.019647553847505494],
 [-2.0025436370318057, -0.05899683838713509],
 [-2.0049609551263967, -0.07877513047311585],
 [-2.0085001559012, -0.09867128542091014],
 [-2.013426765995247, -0.11873798976709359],
 [-2.0200629589962005, -0.13904240899008222],
 [-2.0287998481874783, -0.15967001085788107],
 [-2.04011521127814, -0.18072962262614714],
 [-2.05415960010241, -0.2023170617336776],
 [-2.072412721688248, -0.22467861236530126],
 [-2.0954114856283392, -0.2480082927809628],
 [-2.1242504563441367, -0.27259381739910665],
 [-2.1602940423691206, -0.298804872492878],
 [-2.203985171029039, -0.3269303168644656],
 [-4.519421344452415, -0.7158060202318585],
 [-4.658330322376438, -0.7847618546592514],
 [-4.8268708658819675, -0.8619697694588049],
 [-5.042463094921434, -0.9516439686490478],
 [-5.312995955672269, -1.0568206034213201],
 [-6.837695044740748, -1.4300258490391287],
 [-6.428314083764196, -1.410416327262231],
 [-6.627058508714011, -1.5223646184939468],
 [-3.484839024234306, -0.8366358285321341],
 [-3.3399996796150395, -0.8366263667867052],
 [-3.218754568942458, -0.8399226741259033],
 [-3.1213950072260057, -0.8473330457152334],
 [-3.046206819201637, -0.8591191756957852],
 [-2.987125576383709, -0.874204108017856],
 [-2.943406845542586, -0.8928727051024917],
 [-2.912693171942123, -0.9148767122092967],
 [-2.8930175805447567, -0.9399983934670595],
 [-2.8820353042443627, -0.9678125765401852],
 [-2.878493908351942, -0.9981746831397412],
 [-2.88061734720891, -1.0307013677492152],
 [-2.8878002168127366, -1.0653657459842003],
 [-2.8987774986095363, -1.10186600590954],
 [-2.9126689723775425, -1.1399966610500016],
 [-2.9287326750572413, -1.179570190773803],
 [-2.9456298734772073, -1.2201198433256029],
 [-6.864901692117862, -2.922819687422791],
 [-6.909446412462581, -3.0222538570533164],
 [-4.752781300376605, -2.1347384067811372],
 [-4.4608791864280954, -2.0564934728407507],
 [-4.2173872155381344, -1.9946755992439122],
 [-4.067055689797113, -1.97266359583025],
 [-4.091055904330768, -2.0341562666581066],
 [-4.1140364050762335, -2.096206248532911],
 [-4.093259019242134, -2.136494039325624],
 [-4.000376952082473, -2.1382460288889678],
 [-4.000390479864088, -2.189015602810718],
 [-4.0006705119142145, -2.240483138610721],
 [-4.001236135017332, -2.2926889351670123],
 [-4.002106276846344, -2.345675077777367],
 [-4.00330247331257, -2.3994871610553488],
 [-4.001625996341551, -2.4521995643993426],
 [-4.003420680390099, -2.5076912522726698],
 [-4.002166014250941, -2.561953123915195],
 [-4.001092685309812, -2.6169951721247613],
 [-4.003860101433056, -2.6752937889949657],
 [-4.003297594865594, -2.7321444538031576],
 [-4.002958264427414, -2.789906525587472],
 [-4.002853917317572, -2.8486250481695436],
 [-4.002999907827353, -2.908349672638111],
 [-4.003407459932951, -2.969129329608814],
 [-4.00409249740404, -3.031018709354609],
 [-4.005068494847382, -3.0940732149994323],
 [-4.001726919618117, -3.154707131994933],
 [-4.0031897076547445, -3.220085357194507],
 [-4.004982850984544, -3.286804483435515],
 [-4.002098818620822, -3.350727054002471],
 [-4.004449135636918, -3.4201226626683643],
 [-4.00187318505636, -3.4864466603731175],
 [-4.004825196715935, -3.5587762767705944],
 [-4.0025883411224745, -3.6277346117253995],
 [-4.006187946811058, -3.7032820458278572],
 [-4.004321538309513, -3.775131460828487],
 [-4.0025816935430045, -3.848408056836614],
 [-4.007151028730803, -3.9292332548974787],
 [-4.005823979296168, -4.005823979296167],
 [-4.936309396223572, -5.034197766334163],
 [-4.841652912050714, -5.035617592016206],
 [-4.748486953678355, -5.036769919218408],
 [-4.649871789755855, -5.030202962618901],
 [-4.559827347873451, -5.030994197078055],
 [-4.471172833659957, -5.031579461736264],
 [-4.383876740063405, -5.031976818132218],
 [-4.297908201966811, -5.032203953464368],
 [-4.213234931585046, -5.032275762995063],
 [-4.129828593464224, -5.032210701210186],
 [-4.04765852001406, -5.032023418639632],
 [-4.010369880308991, -5.087129941443942],
 [-4.011322101511059, -5.192385136060812],
 [-4.003601428893377, -5.288911742627109],
 [-4.0046966938741475, -5.3997084125456],
 [-4.005963982567264, -5.51373639966428],
 [-4.007402164925553, -5.631153690952326],
 [-4.009008945669631, -5.752126583471271],
 [-4.010784148316402, -5.876835140297785],
 [-4.012724900013943, -6.005467209352165],
 [-1.9872816770117787, -3.038331238145277],
 [-1.9446019505856633, -3.0377682422177097],
 [-1.902471413268435, -3.0372133701974846],
 [-1.860874667246759, -3.036671465281851],
 [-1.8197961141428962, -3.036146391159961],
 [-1.7792205969001313, -3.0356420572517737],
 [-1.7408122051510069, -3.038092343313035],
 [-1.7011210731526396, -3.037570244236543],
 [-1.6618909371002273, -3.037078710088584],
 [-1.623107446059413, -3.0366204497727045],
 [-1.5847562995442943, -3.0361975727571013],
 [-1.5468237189785916, -3.0358124810319294],
 [-1.5105541715718274, -3.037997455609968],
 [-1.4733534693527863, -3.0376241662692487],
 [-1.4365327811823132, -3.0372933766052905],
 [-1.4000789636545041, -3.0370060449036207],
 [-1.3639785081704128, -3.036761566267423],
 [-1.328219089753563, -3.0365611423554797],
 [-1.2927880958926885, -3.036404614774231],
 [-1.2585344481699612, -3.0383709334856617],
 [-1.2236738241784435, -3.0382367581980496],
 [-1.1891072385562198, -3.038145528761616],
 [-1.1548232125976088, -3.0380967609456793],
 [-1.120810098910622, -3.0380887116376245],
 [-1.0870567403814746, -3.0381200624400106],
 [-1.0535523087141214, -3.038189561394796],
 [-1.0202860374135125, -3.0382952769277582],
 [-0.9872472464154869, -3.0384345974145432],
 [-0.9544260260362912, -3.0386063302962203],
 [-0.9213671070787263, -3.0373403002861266],
 [-0.8889833589597537, -3.037625772028443],
 [-0.8567861450291945, -3.037934516444318],
 [-0.8247662057980024, -3.038263561093089],
 [-0.7929146507885825, -3.038610259763739],
 [-0.7609271309367618, -3.0377913898416704],
 [-0.7294111747116315, -3.038216198327744],
 [-0.6980365883968916, -3.0386474149048994],
 [-0.6665727666875341, -3.038066860916628],
 [-0.6354781773043028, -3.0385506576081633],
 [-0.6043202874152, -3.038123246815272],
 [-0.5734704323199482, -3.0386400652620527],
 [-0.5425789041226081, -3.0383412476239315],
 [-0.5119410854447797, -3.0388718149829255],
 [-0.48127915737461546, -3.0386770088555033],
 [-0.45072649535540993, -3.038551216298002],
 [-0.4203564675147701, -3.0390855572983635],
 [-0.38998199388248583, -3.039025009352908],
 [-0.35969085862793154, -3.039012720071198],
 [-0.3294746065873339, -3.039040338448656],
 [-0.2993252234223993, -3.0390999947167154],
 [-0.26923509659846107, -3.0391842134073705],
 [-0.23919695841631014, -3.039285525907914],
 [-0.20920383856341976, -3.0393958809497277],
 [-0.17923545848105105, -3.039275553081538],
 [-0.1493172116795344, -3.0394216681961206],
 [-0.11942438251975154, -3.0395535063429078],
 [-0.08954812548087994, -3.039553199667158],
 [-0.05969144737884236, -3.0396697617575925],
 [-0.029843299921793423, -3.0397159058674443],
 [-5.584004375158278e-16, -3.0397904],
 [0.029844931560268836, -3.039882097858093],
 [0.059697531860134795, -3.039979602021418],
 [0.08956342675169847, -3.040072574321056],
 [0.11944785988957435, -3.04015104530658],
 [0.1493556414820665, -3.0402039247974204],
 [0.1792911914708665, -3.0402206111347],
 [0.20927594023524723, -3.0404434024764373],
 [0.23928376555982503, -3.040388515245956],
 [0.26935860062024025, -3.04057835361431],
 [0.2994539101259369, -3.040406572744364],
 [0.3296345234277493, -3.0405153951574477],
 [0.3598764266710369, -3.0405805765510387],
 [0.39023721775045017, -3.0410139004553116],
 [0.42061827069725494, -3.0409783371940833],
 [0.45106905232107497, -3.040860547778166],
 [0.48167036868478696, -3.041147019857664],
 [0.5123624241687723, -3.0413728730329646],
 [0.5431472886548908, -3.0415240956038803],
 [0.5740263624941343, -3.0415857649975027],
 [0.6050008404945201, -3.041544618187431],
 [0.6360713643200726, -3.041386992294748],
 [0.6673744543673187, -3.0417207467254737],
 [0.6987944942165012, -3.041946681157963],
 [0.7303312062351257, -3.0420484054210224],
 [0.7619842648054658, -3.042011704814944],
 [0.793752569336064, -3.0418213341116465],
 [0.8258243637166186, -3.0421615901629226],
 [0.8580301837549701, -3.042345545038509],
 [0.8903681623919896, -3.0423575980548376],
 [0.9228360056025681, -3.042182609772999],
 [0.9556638234294536, -3.042547106104799],
 [0.9886373593646816, -3.0427129251530975],
 [2.366276124152895, -7.046500009101696],
 [2.4439038551951477, -7.0476265112728935],
 [2.521890401413331, -7.048211504691124],
 [2.6002246391425055, -7.048217295310813],
 [2.6788938991430933, -7.0476058925044125],
 [2.7585975403340113, -7.048162277604645],
 [1.9857777128474683, -4.9304501915241],
 [1.9849279902445307, -4.792040074382313],
 [1.9853275291931138, -4.662989774296848],
 [1.9868421025809817, -4.542298459068715],
 [1.9868286054392614, -4.423474938657056],
 [1.9855689965601124, -4.307032104379467],
 [1.9878345894824994, -4.202923115651372],
 [1.986705935967396, -4.0960068903330615],
 [2.0119801040706813, -4.046455633262242],
 [2.06160808653826, -4.046133688874363],
 [2.11194580313663, -4.046227626999725],
 [2.1630048697195634, -4.046697485304956],
 [2.214792607735896, -4.047497537926945],
 [2.26675498348866, -4.0475822664753],
 [2.319438009246509, -4.0479190321794585],
 [2.3721380496242577, -4.047256445655227],
 [2.425871427990089, -4.047321963306395],
 [2.4807420412442256, -4.048203085335705],
 [2.5360907175525, -4.04875919904157],
 [2.591858048410424, -4.048882119770714],
 [2.6479737972303954, -4.048455535509675],
 [2.705313137623805, -4.048787231582446],
 [2.763988784261945, -4.049957767375256],
 [2.821909097469839, -4.048875558940526],
 [2.8822845002988395, -4.050151777700104],
 [2.942939835500593, -4.0506091826174275],
 [3.003742258986557, -4.050077592587373],
 [3.0659929655229914, -4.050294837328207],
 [3.1298152556694943, -4.051334148916353],
 [3.193681882026758, -4.0511661543432504],
 [3.259171474129753, -4.051781320506803],
 [3.324530392940175, -4.0509520047219825],
 [3.391541117185362, -4.05084701906056],
 [3.460334797256045, -4.05153149597136],
 [3.531055510130339, -4.0530768824163905],
 [3.601430317117655, -4.052825397413757],
 [3.6737415039804766, -4.053349124437842],
 [3.748139167614834, -4.054714107769847],
 [3.821872089101296, -4.053899812986564],
 [0.9962857067085307, -1.0361985715433764],
 [0.9962512088040856, -1.0160071436985116],
 [0.9960183083213778, -0.9960183083213784],
 [0.9964372173907436, -0.9770618134723268],
 [0.996672582958242, -0.9582822018279563],
 [0.9967315449163856, -0.9396829343536071],
 [0.9966211145933445, -0.921267082115892],
 [0.9963486796122092, -0.9030378051224917],
 [0.9967575781224938, -0.8857408372336631],
 [0.9970147045193115, -0.868602883243361],
 [0.9971262738578524, -0.8516262914701466],
 [0.997098714763877, -0.8348133793012572],
 [0.9969385178252603, -0.8181662973393509],
 [0.9966523100632115, -0.8016870905997576],
 [0.9970646050316848, -0.7860223557816726],
 [0.9973558420920391, -0.7704966845911015],
 [0.9967214598258078, -0.7544984024984216],
 [0.9967913095484023, -0.7392708192457899],
 [0.9967571544827998, -0.7241864628253638],
 [0.997418758678324, -0.7098115789819442],
 [0.9971873714266403, -0.6950008895919759],
 [0.9976513318789706, -0.6808705794738644],
 [0.997243783108404, -0.6663369926708621],
 [0.9975298663841081, -0.6524544792381715],
 [0.9977309614875315, -0.6386891359598705],
 [0.9978520770374437, -0.6250417141785574],
 [0.9978975627697678, -0.6115124129482307],
 [0.9978718583138844, -0.5981013746436593],
 [0.997780269977422, -0.5848091356105363],
 [0.9976269107141538, -0.5716353902740312],
 [0.9974167571302537, -0.5585802229558958],
 [0.9978608055922747, -0.5460299147969608],
 [0.9975411421044241, -0.5331968490238862],
 [0.9978658537119386, -0.5208403471366096],
 [0.9981322385915353, -0.5085737775232327],
 [0.9976748069880808, -0.4960642211154782],
 [0.9978445103937841, -0.4839893254697662],
 [0.9979667544515458, -0.4720031223661639],
 [0.9980448073178951, -0.46010495825494574],
 [0.9980822851484162, -0.44829426236493974],
 [0.9980825170895998, -0.4365702484486649],
 [0.9980490895056374, -0.42493216343809337],
 [0.9979850184694561, -0.4133789296952122],
 [0.9984735019515162, -0.4021430802510916],
 [0.9983458469195919, -0.3907450324272373],
 [0.9981973928137058, -0.37942883676188877],
 [0.9985736117598557, -0.368393254706118],
 [0.9983793369793221, -0.35722583881340264],
 [0.9986902249089769, -0.3463155839624563],
 [0.9984616682640828, -0.3352921313337737],
 [0.9987170017075558, -0.32450282481745824],
 [0.9984647097823168, -0.313617692293202],
 [0.9986742262660948, -0.3029445145419487],
 [0.9988576375959554, -0.2923229799962147],
 [0.998581763718124, -0.2816291843031197],
 [0.9987326432881245, -0.2711156936348876],
 [0.9988633801533306, -0.26064988285841],
 [0.9989760157586159, -0.25023046549139766],
 [0.9990721707817172, -0.2398560069927522],
 [0.9987920421470263, -0.22944201627291957],
 [0.9988755631040993, -0.2191601693301697],
 [0.9989477386459098, -0.2089185140249256],
 [0.9990104286407392, -0.19871552939789683],
 [0.9990651613407816, -0.18854958721163545],
 [0.999113129616568, -0.1784189670550675],
 [0.9991556806798015, -0.1683219546061733],
 [0.9991944159189008, -0.1582568483407173],
 [0.999230302176761, -0.1482218136516309],
 [0.999264558113991, -0.13821503601725246],
 [0.999503872987251, -0.12826104164369215],
 [0.9995216144019108, -0.11830117897399818],
 [0.9995408572449576, -0.10836425122177194],
 [0.9995621462109373, -0.09844827852301412],
 [0.9995862763571979, -0.08855129823532455],
 [0.9996142941960761, -0.07867135111951729],
 [0.9996467002561459, -0.06880641255442342],
 [0.9997752872669982, -0.05895983396755041],
 [0.9998008437113886, -0.04911706584839607],
 [0.9998322708099016, -0.03928351690984283],
 [0.9998696768766516, -0.029457110768543886],
 [0.999913519991728, -0.01963577952213722],
 [0.9999638083810354, -0.009817437144981518]])

# Compute line map
segments = compute_line_map(points, threshold)

# Plotting
fig, (ax1, ax2) = plt.subplots(1, 2, figsize=(12, 6))

# Scatter original points
ax1.scatter(points[:, 0], points[:, 1], s=20, alpha=0.3)
ax1.set_title("Raw Points")

# Scatter with segment coloring
colors = plt.cm.tab10(np.linspace(0, 1, len(segments)))
for i, (seg_points, m, b) in enumerate(segments):
    ax1.scatter(seg_points[:, 0], seg_points[:, 1], s=20, alpha=0.8, color=colors[i], label=f"Segment {i+1}")
ax1.legend()
ax1.set_title("Segmented Points")

# Plot regression lines
ax2.scatter(points[:, 0], points[:, 1], s=20, alpha=0.3)
for i, (seg_points, m, b) in enumerate(segments):
    x_vals = np.linspace(np.min(seg_points[:, 0]), np.max(seg_points[:, 0]), 100)
    y_vals = m * x_vals + b
    ax2.plot(x_vals, y_vals, color=colors[i], label=f"Line {i+1}")
ax2.set_title("Line Map")
ax2.legend()

plt.tight_layout()
plt.show()
